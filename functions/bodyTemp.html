<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>title</title>
		<link rel="stylesheet" type="text/css" href="../css/api.css"/>
		<style>
			.line {
				position: relative;
			}
			.line:after {
				border-bottom: 1px solid #d9d9d9;
				content: "";
				display: block;
				position: absolute;
				bottom: 0;
				left: 0;
				right: 0;
				-webkit-transform-origin: 0 0;
				-webkit-transform: scaleY(0.5);
			}
			.tips {
				height: 0.89rem;
				background: #f6f6f6;
				font-size: 0.28rem;
				width: 100%;
				color: #333333;
				line-height: 0.89rem;
				padding-left: 0.23rem;
				-webkit-box-sizing: border-box;
				-moz-box-sizing: border-box;
				box-sizing: border-box;
			}
			.setbox {
				background: #ffffff;
				height: 2.13rem;
				line-height: 2.13rem;
				display: -webkit-flex; /* 新版本语法: Chrome 21+ */
				display: flex; /* 新版本语法: Opera 12.1, Firefox 22+ */
				display: -webkit-box; /* 老版本语法: Safari, iOS, Android browser, older           WebKit browsers. */
				display: -moz-box; /* 老版本语法: Firefox (buggy) */
				display: -ms-flexbox; /* 混合版本语法: IE 10 */
			}
			.setleft {
				display: block;
				color: #333333;
				font-size: 0.26rem;
				display: -webkit-flex; /* 新版本语法: Chrome 21+ */
				display: flex; /* 新版本语法: Opera 12.1, Firefox 22+ */
				display: -webkit-box; /* 老版本语法: Safari, iOS, Android browser, older           WebKit browsers. */
				display: -moz-box; /* 老版本语法: Firefox (buggy) */
				display: -ms-flexbox; /* 混合版本语法: IE 10 */
				overflow: hidden;
				-webkit-box-orient: vertical;
				-webkit-flex-flow: column;
				flex-flow: column;
				width: 1.36rem;
			}
			.setcon {
				overflow: hidden;
				text-align: right;
				margin-left: 0.2rem;
				font-size: 0.26rem;
				-webkit-flex: 1; /* Chrome */
				-ms-flex: 1; /* IE 10 */
				flex: 1; /* NEW, Spec - Opera 12.1, Firefox 20+ */
				-webkit-box-flex: 1; /* OLD - iOS 6-, Safari 3.1-6 */
				-moz-box-flex: 1;
				margin-right: 0.23rem;
			}
			.setright {
				width: 0.16rem;
				height: 0.28rem;
				margin-right: 0.23rem;
				background: url(../image/setting/icon-todo.png);
				background-size: cover;
				margin-top: 0.925rem;
			}
			.y-line {
				width: 1px;
				height: 1.5rem;
				margin-top: 0.29rem;
				position: relative;
			}
			.y-line:after {
				border-right: 1px solid #d9d9d9;
				content: "";
				display: block;
				position: absolute;
				bottom: 0;
				right: 0;
				top: 0;
				-webkit-transform-origin: 0 0;
				-webkit-transform: scaleX(0.5);
			}
			.txtbox {
				display: block;
				margin-top: 0.29rem;
				margin-left: 0.3rem;
				-webkit-flex: 1; /* Chrome */
				-ms-flex: 1; /* IE 10 */
				flex: 1; /* NEW, Spec - Opera 12.1, Firefox 20+ */
				-webkit-box-flex: 1; /* OLD - iOS 6-, Safari 3.1-6 */
				-moz-box-flex: 1; /* OLD - Firefox 19- */
			}
			.txtbox div {
				text-align: left;
				color: #666666;
				overflow: hidden;
				text-overflow: ellipsis;
				white-space: nowrap;
				word-break: keep-all;
				font-size: 0.28rem;
				line-height: 0.4rem;
			}
			p {
				display: inline-block;
				color: #333333;
			}
			.center {
				display: -webkit-flex; /* 新版本语法: Chrome 21+ */
				display: flex; /* 新版本语法: Opera 12.1, Firefox 22+ */
				display: -webkit-box; /* 老版本语法: Safari, iOS, Android browser, older           WebKit browsers. */
				display: -moz-box; /* 老版本语法: Firefox (buggy) */
				display: -ms-flexbox; /* 混合版本语法: IE 10 */
			}
			.touch {
				background: #EEEEEE;
			}
			.state {
				display: inline-block;
				color: #FF8344;
				font-size: 0.26rem;
				line-height: 1.67rem;
			}
			.destate {
				display: inline-block;
				color: #1EBEB6;
				font-size: 0.26rem;
				line-height: 1.67rem;
			}
			.tips {
				position: relative;
			}
			.tips:after {
				border-bottom: 1px solid #d9d9d9;
				content: "";
				display: block;
				position: absolute;
				bottom: 0;
				left: 0;
				right: 0;
				-webkit-transform-origin: 0 0;
				-webkit-transform: scaleY(0.5);
			}
			.icon {
				display: block;
				height: 0.9rem;
				width: 0.9rem;
				margin-top: 0.47rem;
				border-radius: 50%;
				background: #FF8344;
				background-size: 100%;
				margin-left: 0.23rem;
			}
			.name {
				text-align: center;
				height: 0.76rem;
				line-height: 0.76rem;
			}
		</style>
	</head>
	<body>

		<!-- <div class="setbox" onclick="list('{{=i}}','{{=it[i].num}}')" tapmode='touch'>
		<div  class="setleft"  >
		<img class="icon" src="{{=it[i].img?../image/setting/icon-icon.png}}">
		<div class="name">张三</div>
		</div>
		<div class="setcon">
		<div class="center">
		<div class="y-line"></div>
		<div class="txtbox">
		<div class="p1"><p>班级名称：</p>{{=it[i].cls}}</div>
		<div class="p2"><p>课程名称：</p>{{=it[i].less}}</div>
		<div class="p2"><p>申请调班：</p>{{=it[i].move}}</div>
		<div class="p2"><p>申请时间：</p>{{=it[i].time}}</div>
		</div>
		<div  {{ if( it[i].num == 0){ }}
		class="state"
		{{  }else if( it[i].num == 1){ }}
		class="destate"
		{{ } }}>{{=it[i].state}}</div>
		</div>
		</div>
		<div class="setright sp">
		</div>
		</div>
		<div class="line"></div>
		-->
		<div id="todo"></div>
		<div id="finish"></div>
	</body>
	<script type="template" id="dotTmpl">
		{{for(var i = 0 ; i<it.length;i++){}}
		<div class="setbox" onclick="list('{{=i}}','{{=it[i].num}}')" tapmode='touch'>
		<div  class="setleft"  >
		<div class="icon" ></div>
		<div class="name">{{=it[i].studentName}}</div>
		</div>
		<div class="setcon">
		<div class="center">
		<div class="y-line"></div>
		<div class="txtbox">
		<div class="p1"><p>班级名称：</p>{{=it[i].cls}}</div>
		<div class="p2"><p>课程名称：</p>{{=it[i].less}}</div>
		<div class="p3"><p id="cleave">请假时间：</p>{{=it[i].move}}</div>
		<div class="p4"><p id="tleave">请假班级：</p>{{=it[i].time}}</div>
		</div>
		<div  {{ if( it[i].num == 0){ }}
		class="state"
		{{  }else { }}
		class="destate"
		{{ } }}>{{=it[i].stute}}</div>
		</div>
		</div>
		<div class="setright sp">
		</div>
		</div>
		<div class="line"></div>
		{{}}}
	</script>
	<script type="text/javascript" src="../script/api.js"></script>
	<script type="text/javascript" src="../script/common.js"></script>
	<script type="text/javascript" src="../script/doT.js"></script>
	<script type="text/javascript" src="../script/jquery-3.1.1.js"></script>
	<script type="text/javascript">
		var pageindex = 1;
		var pagesize = 20;
		var imageUrl;
		var loadEnd = false;
		var page ;
		function json(type) {
			var state = ['待处理', '已完成', '已完成'];
			var adate = [];
			var bdate = [];
			for (var i = 0; i < HotCitiesinfo.length; i++) {
				var list = {};
				var s = HotCitiesinfo[i].status;
				list.img = imageUrl + HotCitiesinfo[i].studentImg;
				list.studentName = HotCitiesinfo[i].studentName;
				list.cls = HotCitiesinfo[i].oldClassName;
				list.less = HotCitiesinfo[i].oldCourseName;
				list.move = HotCitiesinfo[i].oldCoursePeriod;
				list.time = HotCitiesinfo[i].createTime.substring(0, 16);
				list.num = s;
				list.stute = state[s];
				if (list.num == 2) {
					bdate.push(list);
				} else {
					adate.push(list);
				}
			}
			var tmpl = doT.template($api.text($api.dom("#dotTmpl")));
			if (pageindex == 1) {
				$api.dom('#todo').innerHTML = '';
				$api.dom('#finish').innerHTML = '';
			}
			if (pageindex==page) {
			    loadEnd=true;
			} else {
			}
			$api.dom('#todo').innerHTML += tmpl(adate);
			$api.dom('#finish').innerHTML += tmpl(bdate);
			var icon = $api.domAll('.icon');
			alert(HotCitiesinfo.length+"---"+$api.domAll('#cleave').length)
			for (var i = 0; i < $api.domAll('#cleave').length; i++) {

				if (HotCitiesinfo[i].studentImg.length > 0) {
					$api.css(icon[i], "background: url(" + imageUrl + HotCitiesinfo[i].studentImg + ";background-size: 100%;)");
				} else {
					$api.css(icon[i], "background: url(../image/setting/icon-icon.png);background-size: 100%;");
				}
				if (type == '0') {
					$api.text($api.domAll('#cleave')[i], '请假课时：');
					$api.text($api.domAll('#tleave')[i], '请假时间：');
				} else if (type == '1') {
					$api.text($api.domAll('#cleave')[i], '申请调班：');
					$api.text($api.domAll('#tleave')[i], '申请时间：');
				} else if (type == '2') {
					$api.css($api.domAll('.p2')[i], '   display: none;');
					$api.css($api.domAll('.p3')[i], '   display: none;');
					$api.text($api.domAll('#tleave')[i], '旷课时间：');
				}
			}
			api.parseTapmode();
		}

		//点击事件
		function list(tag, stu) {
			var title;
			console.log('当前listviewId：' + tag + '待处理0已处理1：' + stu + '请假1旷课2调班3：' + webtodo);
			if (stu == 0) {
				title = '请假处理';
			} else {
				title = '请假详情';
			}
			switch(webtodo) {
				case '1':
					//调课处理
					var imagepath;
					if (HotCitiesinfo[tag].studentImg.length > 0) {
						imagepath = HotCitiesinfo[tag].studentImg;
					} else {
						imagepath = "../image/setting/icon-icon.png";
					}
					api.openWin({
						name : 'leavetodo',
						url : 'leavetodo.html',
						pageParam : {
							id : tag,
							stute : stu,
							web : webtodo,
							studentImg : imagepath,
							studentphone:HotCitiesinfo[tag].studentPhone,
							studentName : HotCitiesinfo[tag].studentName,
							oldClassName : HotCitiesinfo[tag].oldClassName,
							createTime : HotCitiesinfo[tag].oldCoursePeriod,
							timetableId : HotCitiesinfo[tag].oldClassTimetableId
						}
					});
					break;
				case '2':
					var imagepath;
					if (HotCitiesinfo[tag].studentImg.length > 0) {
						imagepath = HotCitiesinfo[tag].studentImg;
					} else {
						imagepath = "../image/setting/icon-icon.png";
					}
					//旷课处理
					api.openWin({
						name : 'leavetodo2',
						url : 'leavetodo2.html',
						pageParam : {
							id : tag,
							stute : stu,
							web : webtodo,
							studentImg : imagepath,
							studentphone:HotCitiesinfo[tag].studentPhone,
							studentName : HotCitiesinfo[tag].studentName,
							oldClassName : HotCitiesinfo[tag].oldClassName,
							createTime : HotCitiesinfo[tag].oldCoursePeriod,
							timetableId : HotCitiesinfo[tag].oldClassTimetableId
						}
					});
					break;
				case '3':
					//调班
					var imagepath;
					if (HotCitiesinfo[tag].studentImg.length > 0) {
						imagepath = HotCitiesinfo[tag].studentImg;
					} else {
						imagepath = "../image/setting/icon-icon.png";
					}
					api.openWin({
						name : 'leavetodo3',
						url : 'leavetodo3.html',
						pageParam : {
							id : tag,
							stute : stu,
							web : webtodo
						}
					});
					break;
			}
		}

		var userid;
		var HotCitiesinfo;
		function getHotCities(type) {
			var userid = api.getPrefs({
				sync : true,
				key : 'userid'
			});
			if (type == '3') {
				var data2 = {};
				data2.method = "changeClassTaskTeacher";
				data2.request = {
					"teacherId" : userid,
					"page" : pageindex,
					"pageSize" : pagesize
				}, api.showProgress();
				console.log('changeClassTaskTeacher调班请求数据' + JSON.stringify(data2));
				ajaxRequest(data2, function(ret, err) {
					api.hideProgress();
					api.refreshHeaderLoadDone();
					if (ret) {
						if (ret.responseBody != null) {
							HotCitiesinfo = null;
							HotCitiesinfo = ret.responseBody.rows;
							if (HotCitiesinfo != null) {
								json('2');
							}
						} else {
							alert(ret.responseMsg);
						}
					} else {
						alert(err.msg)
					}
				})
			} else {
				var data = {};
				data.method = "leaveTaskTeacher";
				data.request = {
					"teacherId" : userid,
					"type" : type,
					"page" : pageindex,
					"pageSize" : pagesize
				}, api.showProgress();
				console.log('leaveTaskTeacher:请求数据' + type + '--' + JSON.stringify(data))
				ajaxRequest(data, function(ret, err) {
					api.hideProgress();
					api.refreshHeaderLoadDone();
					if (ret) {
						if (ret.responseBody != null) {
							HotCitiesinfo = null;
							HotCitiesinfo = ret.responseBody.rows;
							page=ret.totalPage;
							loadEnd = ret.responseBody.totalPage==pageindex;
							console.log('leaveTaskTeacher:返回数据' + JSON.stringify(HotCitiesinfo));
							switch(type) {
								case '0':
									if (HotCitiesinfo != null) {
										json('0');
									}
									break;
								case '1':
									if (HotCitiesinfo != null) {
										json('1');
									}
									break;
								default:
									break;
							}
						}
					} else {
						//alert(JSON.stringify(err))
					}
				})
			}
		}

		var webtodo;
		imready = function() {
			imageUrl = api.getPrefs({
				sync : true,
				key : 'imageUrl'
			});
			api.setRefreshHeaderInfo({
				visible : true,
				loadingImg : 'widget://image/refresh.png',
				bgColor : '#ccc',
				textColor : '#fff',
				textDown : '下拉刷新...',
				textUp : '松开刷新...',
				showTime : true
			}, function(ret, err) {
				//在这里从服务器加载数据，加载完成后调用api.refreshHeaderLoadDone()方法恢复组件到默认状态
				pageindex = 1;
				loadEnd = false;
				var type = api.pageParam.id;
				webtodo = api.pageParam.id;
				console.log('api.pageParam.id的值：' + type + '-' + webtodo);
				switch(type) {
					case '1':
						getHotCities('0');
						break;
					case '2':
						getHotCities('1');
						break;
					case '3':
						getHotCities('3');
						break;
					default:
						api.toast({
							msg : 'api.pageParam.id异常'
						});
						break;
				}
			});
			api.addEventListener({
				name : 'scrolltobottom',
				extra : {
					threshold : 0 //设置距离底部多少距离时触发，默认值为0，数字类型
				}
			}, function(ret, err) {
			if (loadEnd) {
					api.toast({
						msg : '没有更多内容了...',
						location : 'middle'
					});
					return;
				}
				pageindex++;
				api.showProgress();
				var type = api.pageParam.id;
				webtodo = api.pageParam.id;
				switch(type) {
					case '1':
						getHotCities('0');
						break;
					case '2':
						getHotCities('1');
						break;
					case '3':
						getHotCities('3');
						break;
					default:
						api.toast({
							msg : 'api.pageParam.id异常'
						});
						break;
				}
			});
			//页面拉到底时自动加载更多
			//			$(window).scroll(function(event){
			//			    var wScrollY = window.scrollY; // 当前滚动条位置
			//			    var wInnerH = window.innerHeight; // 设备窗口的高度（不会变）
			//			    var bScrollH = document.body.scrollHeight; // 滚动条总高度
			//			    if (wScrollY + wInnerH >= bScrollH) {
			//				    if(loadEnd){
			//						api.toast({
			//		                    msg:'没有更多内容了...',
			//		                    location:'middle'
			//	                    });
			//						return;
			//					}
			//			    	pageindex++;
			//			    	api.showProgress();
			//			    	var type = api.pageParam.id;
			//				    webtodo=api.pageParam.id;
			//					switch(type){
			//					   case '1':
			//					   getHotCities('0');
			//					   break;
			//					   case '2':
			//					   getHotCities('1');
			//					   break;
			//					   case '3':
			//					   getHotCities('3');
			//					   break;
			//					   default:
			//					   api.toast({
			//					       msg:'api.pageParam.id异常'
			//				       });
			//					   break;
			//					}
			//			    }
			//			});
			var type = api.pageParam.id;
			webtodo = api.pageParam.id;
			switch(type) {
				case '1':
					getHotCities('0');
					break;
				case '2':
					getHotCities('1');
					break;
				case '3':
					getHotCities('3');
					break;
				default:
					api.toast({
						msg : 'api.pageParam.id异常'
					});
					break;
			}
		};
	</script>
</html>
